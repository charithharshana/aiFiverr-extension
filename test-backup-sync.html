<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aiFiverr Backup/Sync Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .test-data {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>aiFiverr Backup/Sync System Test</h1>
    
    <div class="test-section">
        <h2>Test Data Setup</h2>
        <button onclick="setupTestData()">Setup Test Data</button>
        <button onclick="clearTestData()">Clear Test Data</button>
        <div id="setupResult"></div>
    </div>

    <div class="test-section">
        <h2>Export Tests</h2>
        <button onclick="testExportCustomPrompts()">Test Export Custom Prompts</button>
        <button onclick="testExportKnowledgeBase()">Test Export Knowledge Base</button>
        <button onclick="testExportAllSettings()">Test Export All Settings</button>
        <div id="exportResults"></div>
    </div>

    <div class="test-section">
        <h2>Import Tests</h2>
        <button onclick="testImportCustomPrompts()">Test Import Custom Prompts</button>
        <button onclick="testImportKnowledgeBase()">Test Import Knowledge Base</button>
        <div id="importResults"></div>
    </div>

    <div class="test-section">
        <h2>Validation Tests</h2>
        <button onclick="testDataValidation()">Test Data Validation</button>
        <button onclick="testConflictResolution()">Test Conflict Resolution</button>
        <div id="validationResults"></div>
    </div>

    <div class="test-section">
        <h2>Current Storage State</h2>
        <button onclick="showCurrentState()">Show Current State</button>
        <div id="currentState"></div>
    </div>

    <!-- Load required scripts -->
    <script src="content/utils/storage.js"></script>
    <script src="content/utils/settings-backup.js"></script>
    <script src="content/utils/export-import.js"></script>

    <script>
        // Mock Chrome storage for testing
        if (typeof chrome === 'undefined') {
            window.chrome = {
                storage: {
                    local: {
                        data: {},
                        get: function(keys, callback) {
                            const result = {};
                            if (typeof keys === 'string') {
                                keys = [keys];
                            }
                            if (Array.isArray(keys)) {
                                keys.forEach(key => {
                                    if (this.data[key]) {
                                        result[key] = this.data[key];
                                    }
                                });
                            } else if (typeof keys === 'object') {
                                Object.keys(keys).forEach(key => {
                                    result[key] = this.data[key] || keys[key];
                                });
                            }
                            callback(result);
                        },
                        set: function(items, callback) {
                            Object.assign(this.data, items);
                            if (callback) callback();
                        },
                        clear: function(callback) {
                            this.data = {};
                            if (callback) callback();
                        }
                    }
                }
            };
        }

        // Mock storage manager
        window.storageManager = {
            get: function(key) {
                return new Promise((resolve) => {
                    chrome.storage.local.get(key, (result) => {
                        resolve(result);
                    });
                });
            },
            set: function(data) {
                return new Promise((resolve) => {
                    chrome.storage.local.set(data, () => {
                        resolve(true);
                    });
                });
            }
        };

        // Initialize managers
        window.settingsBackupManager = new SettingsBackupManager();
        window.initializeExportImportManager();

        // Test data
        const testCustomPrompts = {
            'test_prompt_1': {
                name: 'Test Prompt 1',
                description: 'A test prompt for validation',
                prompt: 'This is a test prompt: {conversation}',
                knowledgeBaseFiles: [],
                created: Date.now(),
                modified: Date.now()
            },
            'test_prompt_2': {
                name: 'Test Prompt 2',
                description: 'Another test prompt',
                prompt: 'Another test: {{bio}} and {reply}',
                knowledgeBaseFiles: ['test-file.txt'],
                created: Date.now(),
                modified: Date.now()
            }
        };

        const testKnowledgeBase = {
            'bio': 'Test bio information for the user',
            'services': 'Web development, AI integration, automation',
            'portfolio': 'https://example.com/portfolio'
        };

        const testFavoritePrompts = ['test_prompt_1'];

        // Test functions
        async function setupTestData() {
            try {
                await storageManager.set({
                    customPrompts: testCustomPrompts,
                    knowledgeBase: testKnowledgeBase,
                    favoritePrompts: testFavoritePrompts
                });
                showResult('setupResult', 'Test data setup successfully', 'success');
            } catch (error) {
                showResult('setupResult', `Setup failed: ${error.message}`, 'error');
            }
        }

        async function clearTestData() {
            try {
                chrome.storage.local.clear();
                showResult('setupResult', 'Test data cleared successfully', 'info');
            } catch (error) {
                showResult('setupResult', `Clear failed: ${error.message}`, 'error');
            }
        }

        async function testExportCustomPrompts() {
            try {
                const exportData = await window.exportImportManager.exportCustomPromptsOnly('json');
                showResult('exportResults', 'Custom prompts export successful', 'success');
                showData('exportResults', exportData.content);
            } catch (error) {
                showResult('exportResults', `Export failed: ${error.message}`, 'error');
            }
        }

        async function testExportKnowledgeBase() {
            try {
                const exportData = await window.exportImportManager.exportKnowledgeBaseOnly('json');
                showResult('exportResults', 'Knowledge base export successful', 'success');
                showData('exportResults', exportData.content);
            } catch (error) {
                showResult('exportResults', `Export failed: ${error.message}`, 'error');
            }
        }

        async function testExportAllSettings() {
            try {
                const exportData = await window.exportImportManager.exportSettingsOnly('json');
                showResult('exportResults', 'All settings export successful', 'success');
                showData('exportResults', exportData.content);
            } catch (error) {
                showResult('exportResults', `Export failed: ${error.message}`, 'error');
            }
        }

        async function testImportCustomPrompts() {
            try {
                // Create test import data
                const importData = {
                    version: '1.0.0',
                    type: 'custom_prompts',
                    data: {
                        customPrompts: {
                            'imported_prompt': {
                                name: 'Imported Prompt',
                                description: 'This was imported',
                                prompt: 'Imported: {conversation}',
                                created: Date.now(),
                                modified: Date.now()
                            }
                        },
                        favoritePrompts: ['imported_prompt']
                    }
                };

                const result = await window.exportImportManager.importCustomPromptsOnly(
                    JSON.stringify(importData), 
                    { merge: true, overwriteConflicts: false }
                );
                
                showResult('importResults', `Import successful: ${result.message}`, 'success');
            } catch (error) {
                showResult('importResults', `Import failed: ${error.message}`, 'error');
            }
        }

        async function testImportKnowledgeBase() {
            try {
                // Create test import data
                const importData = {
                    version: '1.0.0',
                    type: 'knowledge_base',
                    data: {
                        items: {
                            'imported_var': 'This is an imported variable',
                            'another_var': 'Another imported variable'
                        }
                    }
                };

                const result = await window.exportImportManager.importKnowledgeBaseOnly(
                    JSON.stringify(importData), 
                    { merge: true, overwriteConflicts: false }
                );
                
                showResult('importResults', `Import successful: ${result.message}`, 'success');
            } catch (error) {
                showResult('importResults', `Import failed: ${error.message}`, 'error');
            }
        }

        async function testDataValidation() {
            try {
                // Test invalid data
                const invalidData = {
                    version: '1.0.0',
                    type: 'custom_prompts',
                    data: {
                        customPrompts: {
                            'invalid_prompt': {
                                // Missing required fields
                                description: 'Invalid prompt'
                            }
                        }
                    }
                };

                try {
                    await window.exportImportManager.importCustomPromptsOnly(JSON.stringify(invalidData));
                    showResult('validationResults', 'Validation test failed - should have rejected invalid data', 'error');
                } catch (validationError) {
                    showResult('validationResults', `Validation working correctly: ${validationError.message}`, 'success');
                }
            } catch (error) {
                showResult('validationResults', `Validation test error: ${error.message}`, 'error');
            }
        }

        async function testConflictResolution() {
            try {
                // Setup existing data
                await setupTestData();
                
                // Import conflicting data
                const conflictData = {
                    version: '1.0.0',
                    type: 'custom_prompts',
                    data: {
                        customPrompts: {
                            'test_prompt_1': {
                                name: 'Modified Test Prompt 1',
                                description: 'This conflicts with existing',
                                prompt: 'Modified: {conversation}',
                                created: Date.now(),
                                modified: Date.now()
                            }
                        }
                    }
                };

                // Test merge without overwrite
                const result1 = await window.exportImportManager.importCustomPromptsOnly(
                    JSON.stringify(conflictData), 
                    { merge: true, overwriteConflicts: false }
                );
                
                showResult('validationResults', `Conflict resolution (no overwrite): ${result1.conflicts} conflicts detected`, 'info');

                // Test merge with overwrite
                const result2 = await window.exportImportManager.importCustomPromptsOnly(
                    JSON.stringify(conflictData), 
                    { merge: true, overwriteConflicts: true }
                );
                
                showResult('validationResults', `Conflict resolution (with overwrite): conflicts resolved`, 'success');
            } catch (error) {
                showResult('validationResults', `Conflict test error: ${error.message}`, 'error');
            }
        }

        async function showCurrentState() {
            try {
                const customPrompts = await storageManager.get('customPrompts');
                const knowledgeBase = await storageManager.get('knowledgeBase');
                const favoritePrompts = await storageManager.get('favoritePrompts');
                
                const state = {
                    customPrompts: customPrompts.customPrompts || {},
                    knowledgeBase: knowledgeBase.knowledgeBase || {},
                    favoritePrompts: favoritePrompts.favoritePrompts || []
                };
                
                showData('currentState', JSON.stringify(state, null, 2));
            } catch (error) {
                showResult('currentState', `Failed to show state: ${error.message}`, 'error');
            }
        }

        function showResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }

        function showData(containerId, data) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'test-data';
            div.textContent = data;
            container.appendChild(div);
        }

        // Initialize on load
        window.addEventListener('load', () => {
            showResult('setupResult', 'Test environment initialized', 'info');
        });
    </script>
</body>
</html>
