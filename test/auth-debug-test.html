<!DOCTYPE html>
<html>
<head>
    <title>aiFiverr Authentication Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.loading { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        .log {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1565c0; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>aiFiverr Authentication Debug Test</h1>
        <p>This test helps debug the authentication infinite loop issue.</p>

        <div class="test-section">
            <h3>1. Extension Detection</h3>
            <div id="extensionStatus" class="status loading">Checking extension...</div>
            <button onclick="checkExtension()">Check Extension</button>
        </div>

        <div class="test-section">
            <h3>2. Firebase Auth URL Test</h3>
            <div id="firebaseStatus" class="status loading">Testing Firebase auth URL...</div>
            <button onclick="testFirebaseAuth()">Test Firebase Auth</button>
            <iframe id="testFrame" style="width: 100%; height: 200px; border: 1px solid #ddd; display: none;"></iframe>
        </div>

        <div class="test-section">
            <h3>3. Authentication Flow Test</h3>
            <div id="authStatus" class="status loading">Ready to test authentication...</div>
            <button onclick="testAuthentication()" id="authButton">Test Authentication</button>
        </div>

        <div class="test-section">
            <h3>4. Debug Log</h3>
            <div id="debugLog" class="log">Debug log will appear here...\n</div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('debugLog');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[Auth Debug] ${message}`);
        }

        function updateStatus(elementId, message, type = 'loading') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        async function checkExtension() {
            log('Checking for aiFiverr extension...');
            
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                updateStatus('extensionStatus', 'Chrome extension API not available', 'error');
                log('ERROR: Chrome extension API not available');
                return;
            }

            try {
                // Try to ping the extension
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({ type: 'PING' }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });

                if (response && response.success) {
                    updateStatus('extensionStatus', 'Extension detected and responding', 'success');
                    log(`Extension response: ${JSON.stringify(response)}`);
                } else {
                    updateStatus('extensionStatus', 'Extension not responding properly', 'error');
                    log('Extension ping failed - no proper response');
                }
            } catch (error) {
                updateStatus('extensionStatus', `Extension error: ${error.message}`, 'error');
                log(`Extension ping error: ${error.message}`);
            }
        }

        async function testFirebaseAuth() {
            log('Testing Firebase auth URL...');
            const authUrl = 'https://ai-fiverr.web.app/auth.html';
            
            try {
                const response = await fetch(authUrl);
                if (response.ok) {
                    updateStatus('firebaseStatus', 'Firebase auth URL accessible', 'success');
                    log(`Firebase auth URL responded with status: ${response.status}`);
                    
                    // Show the iframe for visual inspection
                    const iframe = document.getElementById('testFrame');
                    iframe.src = authUrl;
                    iframe.style.display = 'block';
                } else {
                    updateStatus('firebaseStatus', `Firebase auth URL error: ${response.status}`, 'error');
                    log(`Firebase auth URL error: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                updateStatus('firebaseStatus', `Firebase auth URL failed: ${error.message}`, 'error');
                log(`Firebase auth URL fetch error: ${error.message}`);
            }
        }

        async function testAuthentication() {
            log('Starting comprehensive authentication flow test...');
            updateStatus('authStatus', 'Testing authentication...', 'loading');

            const button = document.getElementById('authButton');
            button.disabled = true;

            try {
                // First, test if offscreen document can be created
                log('Step 1: Testing offscreen document creation...');

                // Test the authentication flow with detailed logging
                const response = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Authentication test timeout after 60 seconds'));
                    }, 60000); // Increased timeout

                    log('Sending FIREBASE_AUTH_START message to extension...');
                    chrome.runtime.sendMessage({ type: 'FIREBASE_AUTH_START' }, (response) => {
                        clearTimeout(timeout);
                        if (chrome.runtime.lastError) {
                            log(`Chrome runtime error: ${chrome.runtime.lastError.message}`);
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            log(`Received response from extension: ${JSON.stringify(response)}`);
                            resolve(response);
                        }
                    });
                });

                if (response && response.success) {
                    updateStatus('authStatus', 'Authentication successful!', 'success');
                    log(`Authentication success! User: ${response.user?.email || 'Unknown'}`);
                    log(`Full response: ${JSON.stringify(response, null, 2)}`);

                    // Test sign out as well
                    log('Testing sign out...');
                    const signOutResponse = await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Sign out timeout'));
                        }, 30000);

                        chrome.runtime.sendMessage({ type: 'FIREBASE_AUTH_SIGNOUT' }, (response) => {
                            clearTimeout(timeout);
                            if (chrome.runtime.lastError) {
                                reject(new Error(chrome.runtime.lastError.message));
                            } else {
                                resolve(response);
                            }
                        });
                    });

                    if (signOutResponse && signOutResponse.success) {
                        log('Sign out successful!');
                    } else {
                        log(`Sign out failed: ${signOutResponse?.error || 'Unknown error'}`);
                    }

                } else {
                    updateStatus('authStatus', `Authentication failed: ${response?.error || 'Unknown error'}`, 'error');
                    log(`Authentication failed: ${response?.error || 'Unknown error'}`);
                    if (response?.error) {
                        log(`Error details: ${JSON.stringify(response, null, 2)}`);
                    }
                }
            } catch (error) {
                updateStatus('authStatus', `Authentication error: ${error.message}`, 'error');
                log(`Authentication error: ${error.message}`);
                log(`Error stack: ${error.stack}`);
            } finally {
                button.disabled = false;
            }
        }

        function clearLog() {
            logElement.textContent = 'Debug log cleared...\n';
        }

        // Auto-run extension check on load
        window.addEventListener('load', () => {
            log('Auth debug test loaded');
            checkExtension();
        });
    </script>
</body>
</html>
